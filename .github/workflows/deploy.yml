name: Deploy to cPanel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: stream
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Composer dependencies
        run: composer update --no-dev --no-interaction --prefer-dist --optimize-autoloader

        env:
          APP_NAME: Stream
          APP_ENV: production
          APP_KEY: base64:001fhTD1xjuvC+SDdAFzf+64uScZosHu/pQ0MYoaCLw=
          APP_DEBUG: true
          APP_URL: https://stream-africa.name.ng

          APP_LOCALE: en
          APP_FALLBACK_LOCALE: en
          APP_FAKER_LOCALE: en_US

          APP_MAINTENANCE_DRIVER: file
          # APP_MAINTENANCE_STORE=database

          # PHP_CLI_SERVER_WORKERS=4

          BCRYPT_ROUNDS: 12

          LOG_CHANNEL: stack
          LOG_STACK: single
          LOG_DEPRECATIONS_CHANNEL: null
          LOG_LEVEL: debug

          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: jparzkyl_0775454
          DB_USERNAME: jparzkyl_0775454
          DB_PASSWORD: jparzkyl_0775454

          SESSION_DRIVER: file
          SESSION_LIFETIME: 120
          SESSION_ENCRYPT: false
          SESSION_PATH: /
          SESSION_DOMAIN: null

          BROADCAST_CONNECTION: log
          FILESYSTEM_DISK: local
          QUEUE_CONNECTION: database

          CACHE_STORE: file
          # CACHE_PREFIX=

          MEMCACHED_HOST: 127.0.0.1

          REDIS_CLIENT: phpredis
          REDIS_HOST: 127.0.0.1
          REDIS_PASSWORD: null
          REDIS_PORT: 6379

          MAIL_MAILER: log
          MAIL_SCHEME: null
          MAIL_HOST: 127.0.0.1
          MAIL_PORT: 2525
          MAIL_USERNAME: null
          MAIL_PASSWORD: null
          MAIL_FROM_ADDRESS: "hello@example.com"
          MAIL_FROM_NAME: "${APP_NAME}"

          AWS_ACCESS_KEY_ID:
          AWS_SECRET_ACCESS_KEY:
          AWS_DEFAULT_REGION: us-east-1
          AWS_BUCKET:
          AWS_USE_PATH_STYLE_ENDPOINT: false

          VITE_APP_NAME: "${APP_NAME}"

      - name: optimize Laravel
        run: php artisan optimize

      - name: Install NPM dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Deploy to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
